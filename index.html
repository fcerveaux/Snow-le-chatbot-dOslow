<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Snow ‚Äî Chatbot d'OSLOW (FR, discret)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Kaisei+Decol:wght@700&display=swap" rel="stylesheet">
  <style>
    :root{ --rose-bg:#f7e6ec; --rose-100:#fdeff4; --rose-200:#f9dbe6; --rose-300:#f2c3d6; --rose-400:#e3a7c3; --text:#3f2d38; --muted:#6a4f5b; --white:#fff; --radius:18px; --shadow:0 10px 30px rgba(100,60,80,.15) }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--text);
      background: radial-gradient(1200px 800px at 10% -10%, var(--rose-200), transparent), radial-gradient(1200px 800px at 110% 10%, var(--rose-100), transparent), var(--rose-bg);
      display:flex; flex-direction:column}
    header{max-width:900px; margin:24px auto 0; padding:0 16px}
    .brand{display:flex; align-items:center; gap:14px}
    .avatar{width:52px; height:52px; border-radius:50%; background:linear-gradient(135deg, var(--rose-400), var(--rose-200)); box-shadow:var(--shadow); position:relative}
    .avatar:before,.avatar:after{content:""; position:absolute; background:var(--white)}
    .avatar:before{width:18px;height:18px;border-radius:50%; top:18px; left:12px; box-shadow:24px 0 0 var(--white)}
    .avatar:after{width:16px;height:10px;border-radius:10px 10px 0 0; bottom:10px; left:18px; box-shadow:20px 0 0 var(--white)}
    .title{font-family:"Kaisei Decol",serif; font-weight:700; font-size:28px}
    .subtitle{color:var(--muted); font-size:14px; margin-top:2px}

    main{flex:1; display:flex}
    .container{max-width:900px; width:100%; margin:16px auto; padding:0 16px; display:grid; grid-template-rows:auto 1fr auto; gap:16px}

    .chatbox{background:var(--white); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; display:flex; flex-direction:column; gap:16px; min-height:55vh; border:1px solid rgba(100,60,80,.08)}
    .messages{display:flex; flex-direction:column; gap:12px; overflow:auto; padding:6px}
    .bubble{max-width:80%; padding:12px 14px; border-radius:16px; line-height:1.45; font-size:15px; box-shadow:0 4px 16px rgba(60,30,40,.06)}
    .user{align-self:flex-end; background:var(--rose-300); color:#3b2431; border:1px solid rgba(100,60,80,.15)}
    .bot{align-self:flex-start; background:#fff; border:1px solid rgba(100,60,80,.12)}

    form.ask{display:flex; gap:10px; align-items:center; background: var(--white); padding:10px; border-radius: var(--radius); box-shadow: var(--shadow); border:1px solid rgba(100,60,80,.08)}
    .input{flex:1; background:#fff; border:1px solid rgba(100,60,80,.18); padding:12px 14px; border-radius:12px; font-size:15px; outline:none}
    .btn{background:linear-gradient(135deg,var(--rose-400),var(--rose-300)); color:#3f1630; border:none; padding:12px 14px; border-radius:14px; font-weight:700; cursor:pointer; box-shadow:0 6px 18px rgba(227,167,195,.35)}

    footer{max-width:900px; margin:0 auto 24px; padding:0 16px; color:var(--muted); font-size:12px; text-align:center}
    .hint{font-size:12px; color:var(--muted); text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="avatar" aria-hidden="true"></div>
      <div>
        <div class="title">Snow <span aria-hidden="true">üêæ</span></div>
        <div class="subtitle">Chatbot d'OSLOW</div>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="chatbox" role="region" aria-live="polite">
        <div id="messages" class="messages">
          <div class="bubble bot">Bonjour ! Je suis Snow. Pose-moi une question üôÇ</div>
        </div>
        <div class="hint" id="status">Pr√©paration‚Ä¶</div>
      </div>

      <form class="ask" id="ask-form">
        <input id="q" class="input" placeholder="Votre question‚Ä¶" autocomplete="off" />
        <button class="btn" type="submit">Envoyer</button>
      </form>
    </div>
  </main>

  <footer>
    <span class="hint">Confidentialit√©¬†: tout se passe dans votre navigateur. Aucune donn√©e n'est envoy√©e ni stock√©e une fois l'onglet ferm√©.</span>
  </footer>

  <script type="module">
    // === UI ===
    const messages = document.getElementById('messages');
    const statusEl = document.getElementById('status');
    const form = document.getElementById('ask-form');
    const input = document.getElementById('q');

    function addBubble(text, who){
      const b = document.createElement('div');
      b.className = `bubble ${who}`;
      b.textContent = text;
      messages.appendChild(b);
      messages.scrollTop = messages.scrollHeight;
      return b;
    }

    // === 1) Charger connaissances (embeddings.json ou corpus.txt) ===
    let docs = [];
    async function loadKnowledge(){
      async function tryJSON(url){ try{ const r=await fetch(url); if(!r.ok) throw 0; const kb=await r.json(); return kb.map(x=>x.text).filter(Boolean);}catch{ return null; } }
      async function tryTXT(url){ try{ const r=await fetch(url); if(!r.ok) throw 0; const raw=await r.text(); return raw.split(/\n\n+/).map(s=>s.trim()).filter(s=>s.length>10);}catch{ return null; } }
      docs = await tryJSON('./embeddings.json') || await tryTXT('./corpus.txt') || [];
      statusEl.textContent = docs.length ? "Pr√™t." : "Erreur : aucune connaissance trouv√©e.";
    }

    // === 2) Index hybride : BM25 (TF-IDF) + expansion + rerank s√©mantique MiniLM ===
    const stripAccents = (s)=>s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    function tokenize(s){ return stripAccents(s.toLowerCase()).replace(/[^a-z0-9\s√†√¢√§√ß√©√®√™√´√Æ√Ø√¥√∂√π√ª√º√ø≈ì-]/gi,' ').split(/\s+/).filter(w=>w.length>1); }

    // Petit lexique FR pour expansion de requ√™te (synonymes courants)
    const SYN = new Map(Object.entries({
      "sortir":["quitter","partir","s'√©chapper","ouvrir"],
      "cl√©":["clef","cl√©f","code","cadenas"],
      "cr√©ateur":["createur","scientifique","inventeur"],
      "vid√©o":["video","film","enregistrement"],
      "lampe":["uv","ultraviolet","lumi√®re"],
      "tangram":["puzzle","formes","g√©om√©triques"],
      "taquin":["puzzle","glissi√®re","cases"],
      "merci":["thanks","thx"],
      "qr":["qrcode","code barre","scan"]
    }));

    let vocab=new Map(), df=[], D=0, docTerms=[];
    function buildIndex(){
      D = docs.length; vocab.clear(); df=[]; docTerms=[];
      docs.forEach((text,i)=>{
        const terms = tokenize(text); const tf = new Map(); terms.forEach(w=>tf.set(w,(tf.get(w)||0)+1));
        const unique = new Set(terms); unique.forEach(w=>{ if(!vocab.has(w)) vocab.set(w,vocab.size); const id=vocab.get(w); df[id]=(df[id]||0)+1; });
        docTerms[i]=tf;
      });
    }
    function expandQuery(q){
      const toks = tokenize(q);
      const extra = [];
      for(const t of toks){ if(SYN.has(t)) extra.push(...SYN.get(t)); }
      return toks.concat(extra);
    }
    function bm25Scores(q){
      const toks = expandQuery(q);
      const qtf=new Map(); toks.forEach(w=>qtf.set(w,(qtf.get(w)||0)+1));
      const scores=new Float32Array(D); const k1=1.5, b=0.75;
      const avgdl = docTerms.reduce((s,tf)=>s+[...tf.values()].reduce((a,v)=>a+v,0),0)/Math.max(D,1);
      for(let d=0; d<D; d++){
        const tf = docTerms[d]; const dl=[...tf.values()].reduce((a,v)=>a+v,0) || 1;
        let score=0;
        for(const [w,qq] of qtf){ const id=vocab.get(w); if(id===undefined) continue; const f=(tf.get(w)||0); if(!f) continue; const idf=Math.log((D - (df[id]||0) + 0.5)/((df[id]||0)+0.5) + 1);
          score += idf * (f*(k1+1)) / (f + k1*(1 - b + b*dl/avgdl));
        }
        scores[d]=score;
      }
      // top 24 pour rerank
      return Array.from(scores, (s,i)=>({i,s})).sort((a,b)=>b.s-a.s).slice(0,24).filter(x=>x.s>0);
    }

    // === 3) Rerank s√©mantique MiniLM (Transformers.js) ‚Äî sur top-24 uniquement ===
    let embedder=null;
    function dot(a,b){ let s=0; for(let i=0;i<a.length;i++) s+=a[i]*b[i]; return s; }
    function l2(a){ let s=0; for(let i=0;i<a.length;i++) s+=a[i]*a[i]; return Math.sqrt(s)||1; }
    function cos(a,b){ return dot(a,b)/(l2(a)*l2(b)); }

    async function getEmbedder(){
      if(embedder) return embedder;
      const { pipeline } = await import('https://esm.run/@xenova/transformers');
      embedder = await pipeline('feature-extraction','Xenova/all-MiniLM-L6-v2');
      return embedder;
    }
    async function embed(text){
      const out = await embedder(text, { normalize:true });
      const dims = out.dims[out.dims.length-1]; const tokens = out.data.length/dims;
      const vec = new Float32Array(dims);
      for(let t=0;t<tokens;t++){ for(let d=0; d<dims; d++){ vec[d]+=out.data[t*dims+d]; } }
      for(let d=0; d<dims; d++){ vec[d]/=tokens||1; }
      // L2
      const n=l2(vec); for(let d=0; d<vec.length; d++) vec[d]/=n;
      return vec;
    }
    async function rerankSemantic(q, prelim){
      if(prelim.length===0) return [];
      await getEmbedder();
      const qv = await embed(q);
      const scored = [];
      // embed top 24 docs (peu co√ªteux) puis cosine
      for(const h of prelim){
        const dv = await embed(docs[h.i].slice(0,1500));
        scored.push({ i:h.i, s: cos(qv, dv) });
      }
      scored.sort((a,b)=>b.s-a.s);
      return scored.slice(0,4);
    }

    // === 4) LLM local silencieux (Qwen si dispo, sinon TinyLlama) ===
    let engine=null; let llmReady=false; let triedLLM=false;
    async function ensureLLM(){
      if(triedLLM) return; triedLLM=true;
      try{
        const { CreateMLCEngine, prebuiltAppConfig } = await import('https://esm.run/@mlc-ai/web-llm');
        const preferred = ['Qwen2.5-1.5B-Instruct-q4f16_1-MLC','TinyLlama-1.1B-Chat-v1.0-q4f16_1-MLC'];
        const list = (prebuiltAppConfig?.model_list||[]).map(m=>m.model_id);
        const wanted = preferred.find(id=>list.includes(id)) || list[0];
        if(!wanted) throw 0;
        engine = await CreateMLCEngine(wanted, { initProgressCallback:(p)=>{ statusEl.textContent = p.text || '‚Ä¶'; } });
        llmReady=true; statusEl.textContent='Pr√™t.';
      }catch{ llmReady=false; }
    }

    function extractQuoted(s){
      const m = s.match(/["‚Äú‚Äù¬´¬ª](.*?)["‚Äú‚Äù¬´¬ª]/);
      return m ? m[1].trim() : null;
    }

    async function llmAnswer(question, hits){
      const ctx = hits.map(h=>docs[h.i]).join('\n---\n');
      const sys = `Tu es Snow, un petit chat FRAN√áAIS. Tu r√©ponds UNIQUEMENT √† partir des extraits fournis. N'affiche JAMAIS les extraits, ni les sources. Si un extrait contient une r√©plique entre guillemets, r√©p√®te-la exactement. Sinon, reformule en 1 √† 2 phrases claires en fran√ßais. Si l'information n'est pas dans les extraits, dis : "Je suis d√©sol√©, je ne peux pas vous r√©pondre. Pourriez-vous reformuler, ou √™tre plus pr√©cis ?"`;
      const user = `Question: ${question}\n\nEXTRAITS (confidentiels):\n${ctx}`;
      const stream = await engine.chat.completions.create({ messages:[{role:'system',content:sys},{role:'user',content:user}], temperature:0.15, top_p:0.9, stream:true });
      let out=''; for await (const c of stream){ const t=c?.choices?.[0]?.delta?.content||''; if(t) out+=t; }
      out = out.trim();
      // filet de s√©curit√© : si le mod√®le tente de citer, on neutralise les guillemets
      return out.replace(/[‚Äú‚Äù¬´¬ª]/g,'').replace(/\n\n+/, '\n');
    }

    function fallbackParaphrase(hits){
      if(!hits.length) return null;
      const s = hits.map(h=>docs[h.i]).join(' ');
      const quoted = extractQuoted(s);
      if(quoted) return quoted; // ne r√©p√©ter que si explicitement cit√©
      const sentences = s.split(/(?<=[.!?])\s+/).filter(x=>x.length>25);
      const cleaned = sentences.map(x=>x.replace(/[‚Äú‚Äù¬´¬ª\"]/g,'')).join(' ');
      return cleaned.split(/\s+/).slice(0,55).join(' ').trim();
    }

    async function answer(question){
      // 1) recherche BM25 + expansion
      const prelim = bm25Scores(question);
      // 2) rerank s√©mantique MiniLM (top-24 ‚Üí top-4 pertinents)
      const hits = await rerankSemantic(question, prelim);

      if(!hits.length){
        window.__unk = (window.__unk||0)+1;
        if(window.__unk===1) return "Je suis d√©sol√©, je ne peux pas vous r√©pondre. Pourriez-vous reformuler, ou √™tre plus pr√©cis ?";
        if(window.__unk===2) return "Encore une fois, je ne peux malheureusement pas vous r√©pondre‚Ä¶";
        return "Je crois que je commence √† m‚Äôendorm‚Ä¶ Zzzz‚Ä¶ Ah ! Oups, pardonnez-moi. Vous disiez ?";
      }

      // 3) LLM (silencieux) si dispo
      await ensureLLM();
      if(llmReady && engine){ return await llmAnswer(question, hits); }

      // 4) Fallback paraphrase courte
      return fallbackParaphrase(hits) || "Je suis d√©sol√©, je ne peux pas vous r√©pondre. Pourriez-vous reformuler, ou √™tre plus pr√©cis ?";
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const q = input.value.trim(); if(!q) return;
      addBubble(q,'user'); input.value='';
      const thinking = addBubble('‚Ä¶','bot');
      try{
        const res = await answer(q);
        thinking.textContent = res || "(Pas d'info suffisante dans le document.)";
      }catch(err){
        thinking.textContent = "Oups, √©chec. Rechargez la page et r√©essayez.";
        console.error(err);
      }
    });

    // D√©marrage
    await loadKnowledge();
    buildIndex();
  </script>
</body>
</html>
