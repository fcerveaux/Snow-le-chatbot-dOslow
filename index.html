<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Snow ‚Äî mode Lite (sans WebGPU)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Kaisei+Decol:wght@700&display=swap" rel="stylesheet">
  <style>
    :root{
      --rose-bg:#f7e6ec; --rose-100:#fdeff4; --rose-200:#f9dbe6; --rose-300:#f2c3d6; --rose-400:#e3a7c3;
      --text:#3f2d38; --muted:#6a4f5b; --white:#fff; --radius:18px; --shadow:0 10px 30px rgba(100,60,80,.15);
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--text);
      background: radial-gradient(1200px 800px at 10% -10%, var(--rose-200), transparent), radial-gradient(1200px 800px at 110% 10%, var(--rose-100), transparent), var(--rose-bg);
      min-height:100vh; display:flex; flex-direction:column}
    header{max-width:900px; margin:24px auto 0; padding:0 16px}
    .brand{display:flex; align-items:center; gap:14px}
    .avatar{width:52px; height:52px; border-radius:50%; background:linear-gradient(135deg, var(--rose-400), var(--rose-200)); box-shadow:var(--shadow); position:relative}
    .avatar:before,.avatar:after{content:""; position:absolute; background:var(--white)}
    .avatar:before{width:18px;height:18px;border-radius:50%; top:18px; left:12px; box-shadow:24px 0 0 var(--white)}
    .avatar:after{width:16px;height:10px;border-radius:10px 10px 0 0; bottom:10px; left:18px; box-shadow:20px 0 0 var(--white)}
    .title{font-family:"Kaisei Decol",serif; font-weight:700; font-size:28px}
    .subtitle{color:var(--muted); font-size:14px; margin-top:2px}
    main{flex:1; display:flex}
    .container{max-width:900px; width:100%; margin:16px auto; padding:0 16px; display:grid; grid-template-rows:auto 1fr auto; gap:16px}
    .chatbox{background:var(--white); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; display:flex; flex-direction:column; gap:16px; min-height:55vh; border:1px solid rgba(100,60,80,.08)}
    .messages{display:flex; flex-direction:column; gap:12px; overflow:auto; padding:6px}
    .bubble{max-width:100%; padding:12px 14px; border-radius:16px; line-height:1.45; font-size:15px; box-shadow:0 4px 16px rgba(60,30,40,.06)}
    .user{align-self:flex-end; background:var(--rose-300); color:#3b2431; border:1px solid rgba(100,60,80,.15)}
    .bot{align-self:flex-start; background:#fff; border:1px solid rgba(100,60,80,.12)}
    .src{font-size:12px; color:var(--muted); margin-top:6px}
    form.ask{display:flex; gap:10px; align-items:center; background:var(--white); padding:10px; border-radius:var(--radius); box-shadow:var(--shadow); border:1px solid rgba(100,60,80,.08)}
    .input{flex:1; background:#fff; border:1px solid rgba(100,60,80,.18); padding:12px 14px; border-radius:12px; font-size:15px; outline:none}
    .btn{background:linear-gradient(135deg,var(--rose-400),var(--rose-300)); color:#3f1630; border:none; padding:12px 14px; border-radius:14px; font-weight:700; cursor:pointer; box-shadow:0 6px 18px rgba(227,167,195,.35)}
    footer{max-width:900px; margin:0 auto 24px; padding:0 16px; color:var(--muted); font-size:12px; text-align:center}
    .badge{display:inline-block; padding:6px 10px; border-radius:999px; background:rgba(227,167,195,.28); border:1px solid rgba(100,60,80,.12)}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="avatar" aria-hidden="true"></div>
      <div>
        <div class="title">Snow <span aria-hidden="true">üêæ</span></div>
        <div class="subtitle">Mode Lite : r√©ponses extraites du document (sans LLM, 100% navigateur).</div>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="chatbox" role="region" aria-live="polite">
        <div id="messages" class="messages">
          <div class="bubble bot">Bonjour ! Je suis Snow (mode Lite). Pose-moi une question, je te renverrai les passages les plus pertinents de ton document.</div>
        </div>
        <div class="bubble bot" id="status">Chargement des connaissances‚Ä¶</div>
      </div>

      <form class="ask" id="ask-form">
        <input id="q" class="input" placeholder="Votre question‚Ä¶" autocomplete="off" />
        <button class="btn" type="submit">Envoyer</button>
      </form>
    </div>
  </main>

  <footer>
    <span class="badge">Confidentialit√© : tout se passe dans votre navigateur. Aucune donn√©e n'est envoy√©e ni stock√©e une fois l'onglet ferm√©.</span>
  </footer>

  <script type="module">
    import { pipeline } from "https://esm.run/@xenova/transformers";

    const messages = document.getElementById('messages');
    const status = document.getElementById('status');
    const form = document.getElementById('ask-form');
    const input = document.getElementById('q');

    function addBubble(text, who){
      const b = document.createElement('div');
      b.className = `bubble ${who}`;
      b.textContent = text;
      messages.appendChild(b);
      messages.scrollTop = messages.scrollHeight;
    }

    // Cosine utils
    const dot = (a,b)=>{ let s=0; for(let i=0;i<a.length;i++) s+=a[i]*b[i]; return s; };
    const norm = (a)=>Math.sqrt(dot(a,a))||1;
    const cos = (a,b)=>dot(a,b)/(norm(a)*norm(b));

    // 1) Charger embeddings.json
    let kb = [];
    try{
      const res = await fetch('./embeddings.json');
      if(!res.ok) throw new Error(`embeddings.json introuvable (${res.status})`);
      kb = await res.json();
    }catch(err){
      status.textContent = "Erreur: impossible de charger embeddings.json (placez-le √† la racine du d√©p√¥t).";
      throw err;
    }

    // 2) D√©marrer l'encodeur d'embeddings c√¥t√© client (CPU/WASM)
    status.textContent = "Initialisation de l'encodeur‚Ä¶";
    const embedder = await pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2');
    status.textContent = `Connaissances pr√™tes (${kb.length} passages).`;

    function topK(question, k=3){
      return embedder(question, { normalize: true }).then(t => {
        // mean pooling
        const dims = t.dims[t.dims.length-1];
        const tokens = t.data.length / dims;
        const q = new Float32Array(dims);
        for(let tok=0; tok<tokens; tok++){
          for(let d=0; d<dims; d++) q[d] += t.data[tok*dims + d];
        }
        for(let d=0; d<dims; d++) q[d] /= tokens || 1;
        let n=0; for(let d=0; d<dims; d++) n+=q[d]*q[d]; n=Math.sqrt(n)||1; for(let d=0; d<dims; d++) q[d]/=n;

        const scored = kb.map(ch=>({ text: ch.text, score: cos(q, ch.vector) }));
        scored.sort((a,b)=>b.score-a.score);
        return scored.slice(0,k);
      });
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const q = input.value.trim();
      if(!q) return;
      addBubble(q, 'user');
      input.value = '';

      const thinking = document.createElement('div');
      thinking.className = 'bubble bot';
      thinking.textContent = '‚Ä¶';
      messages.appendChild(thinking);

      try{
        const hits = await topK(q, 3);
        const text = hits.map((h,i)=>`[${i+1}] ${h.text}`).join('\n\n');
        thinking.textContent = text || "(Pas d'extrait pertinent trouv√© dans le document.)";
        const src = document.createElement('div');
        src.className = 'src';
        src.textContent = "R√©ponse extraite de votre document (aucun stockage, aucun envoi).";
        thinking.appendChild(src);
      }catch(err){
        thinking.textContent = "Oups, √©chec. Rechargez la page et r√©essayez.";
        console.error(err);
      }
    });
  </script>
</body>
</html>