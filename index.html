<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Snow â€” Chatbot d'OSLOW (ultra-stable, corpus embarquÃ©)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Kaisei+Decol:wght@700&display=swap" rel="stylesheet">
  <style>
    :root{ --rose-bg:#f7e6ec; --rose-100:#fdeff4; --rose-200:#f9dbe6; --rose-300:#f2c3d6; --rose-400:#e3a7c3; --text:#3f2d38; --muted:#6a4f5b; --white:#fff; --radius:18px; --shadow:0 10px 30px rgba(100,60,80,.15) }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--text);
      background: radial-gradient(1200px 800px at 10% -10%, var(--rose-200), transparent), radial-gradient(1200px 800px at 110% 10%, var(--rose-100), transparent), var(--rose-bg);
      display:flex; flex-direction:column}
    header{max-width:900px; margin:24px auto 0; padding:0 16px}
    .brand{display:flex; align-items:center; gap:14px}
    .avatar{width:52px; height:52px; border-radius:50%; background:linear-gradient(135deg, var(--rose-400), var(--rose-200)); box-shadow:var(--shadow); position:relative}
    .avatar:before,.avatar:after{content:""; position:absolute; background:var(--white)}
    .avatar:before{width:18px;height:18px;border-radius:50%; top:18px; left:12px; box-shadow:24px 0 0 var(--white)}
    .avatar:after{width:16px;height:10px;border-radius:10px 10px 0 0; bottom:10px; left:18px; box-shadow:20px 0 0 var(--white)}
    .title{font-family:"Kaisei Decol",serif; font-weight:700; font-size:28px}
    .subtitle{color:var(--muted); font-size:14px; margin-top:2px}
    main{flex:1; display:flex}
    .container{max-width:900px; width:100%; margin:16px auto; padding:0 16px; display:grid; grid-template-rows:auto 1fr auto; gap:16px}
    .chatbox{background:var(--white); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; display:flex; flex-direction:column; gap:16px; min-height:55vh; border:1px solid rgba(100,60,80,.08)}
    .messages{display:flex; flex-direction:column; gap:12px; overflow:auto; padding:6px}
    .bubble{max-width:80%; padding:12px 14px; border-radius:16px; line-height:1.45; font-size:15px; box-shadow:0 4px 16px rgba(60,30,40,.06)}
    .user{align-self:flex-end; background:var(--rose-300); color:#3b2431; border:1px solid rgba(100,60,80,.15)}
    .bot{align-self:flex-start; background:#fff; border:1px solid rgba(100,60,80,.12)}
    form.ask{display:flex; gap:10px; align-items:center; background: var(--white); padding:10px; border-radius: var(--radius); box-shadow: var(--shadow); border:1px solid rgba(100,60,80,.08)}
    .input{flex:1; background:#fff; border:1px solid rgba(100,60,80,.18); padding:12px 14px; border-radius:12px; font-size:15px; outline:none}
    .btn{background:linear-gradient(135deg,var(--rose-400),var(--rose-300)); color:#3f1630; border:none; padding:12px 14px; border-radius:14px; font-weight:700; cursor:pointer; box-shadow:0 6px 18px rgba(227,167,195,.35)}
    footer{max-width:900px; margin:0 auto 24px; padding:0 16px; color:var(--muted); font-size:12px; text-align:center}
    .hint{font-size:12px; color:var(--muted); text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="avatar" aria-hidden="true"></div>
      <div>
        <div class="title">Snow <span aria-hidden="true">ğŸ¾</span></div>
        <div class="subtitle">Chatbot d'OSLOW</div>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="chatbox" role="region" aria-live="polite">
        <div id="messages" class="messages">
          <div class="bubble bot">Bonjour ! Je suis Snow. Pose-moi une question ğŸ™‚</div>
        </div>
        <div class="hint" id="status">PrÃ©parationâ€¦</div>
      </div>

      <form class="ask" id="ask-form">
        <input id="q" class="input" placeholder="Votre questionâ€¦" autocomplete="off" />
        <button class="btn" type="submit">Envoyer</button>
      </form>
    </div>
  </main>

  <footer>
    <span class="hint">ConfidentialitÃ© : tout se passe dans votre navigateur. Aucune donnÃ©e n'est envoyÃ©e ni stockÃ©e une fois l'onglet fermÃ©.</span>
  </footer>

  <!-- OPTION B : corpus intÃ©grÃ© directement dans la page -->
  <!-- Remplacez le texte DÃ‰MO ci-dessous par VOTRE corpus. Conservez les sauts de ligne vides pour sÃ©parer les "passages". -->
  <script id="corpus" type="text/plain">
- Si on demande qui on est, rÃ©pondre "Je suis le ChatBot d'OSLOW, pour vous servir ! Vous pouvez mâ€™appeler Snow. Comment puis-je vous Ãªtre utile ?"
- Si on demande de donner la rÃ©ponse ou d'expliquer comment sortir, rÃ©pondre "Ah ah ah, ce ne sera pas si facile..."
- Pour toute autre question, rÃ©pondre "Je suis dÃ©solÃ©, je ne comprends pas. Pouvez-vous Ãªtre plus prÃ©cis ?" ou "Je crois que vous Ãªtes hors-sujet..."
- Si on te demande quelque chose que tu ne sais pas, rÃ©pondre : Â« Je suis dÃ©solÃ©, je ne peux pas vous rÃ©pondre. Pourriez-vous reformuler, ou Ãªtre plus prÃ©cis ? Â».
- Si on te demande une deuxiÃ¨me fois de suite quelque chose que tu ne sais pas, rÃ©pondre : Â« Encore une fois, je ne peux malheureusement pas vous rÃ©pondreâ€¦ Â»
- Si on te pose Ã  la suite encore dâ€™autres questions pour lesquelles tu nâ€™as pas de rÃ©ponse, rÃ©pondre : Â« Je crois que je commence Ã  mâ€™endormâ€¦ Zzzzâ€¦ Ah ! Oups, pardonnez-moi. Vous disiez ? Â» 
- Si on te demande quel est le code du cadenas, rÃ©pondre : Â« Je ne suis pas autorisÃ© Ã  vous transmettre cette information. Vous devrez vous dÃ©brouillez seuls pour le retrouver. Mais le crÃ©ateur laisse souvent traÃ®ner des indices pour se rappeler de ses codes et mots de passe. Fouillez bien, on ne sait jamais. Â»
- Si on te demande qui est le crÃ©ateur, rÃ©pondre : Â« Câ€™est un scientifique philanthrope et environnementaliste. Je crois que ses derniÃ¨res Ã©tudes sur votre consommation des ressources naturelles lâ€™a rendu moins philanthropeâ€¦ Il a passÃ© de plus en plus de temps dans ce laboratoire. Vous nâ€™Ãªtes pas les premiers humains Ã  vous y retrouver enfermÃ©s. Â»
- Si on te demande le nom du crÃ©ateur, rÃ©pondre : Â« Il sâ€™appelleâ€¦ euhâ€¦ Eh bien, je me rends compte quâ€™il ne mâ€™a jamais donnÃ© son nom. Moi qui pensais que nous Ã©tions prochesâ€¦ Â»
- Si on demande oÃ¹ est la clÃ©, rÃ©pondre "VoilÃ  une question que vous les humains posez souvent. Je ne sais pas ce que vous faites de vos clÃ©sâ€¦ Je suis limitÃ© dans mes recherches, je ne suis quâ€™une tablette. Je ne vois mÃªme pas mon dosâ€¦".
- Si on demande comment faire sa part, rÃ©pondre "On doit tous faire notre part du travail. Câ€™est comme Ã§a quâ€™Ã  la fin, on obtient un rÃ©sultat complet et satisfaisant (et souvent trÃ¨s utile). Je suis certain que vous trouverez votre part quelque part. Soyez organisÃ©s : commencez par ce quâ€™il y a sous votre nez !"
- Si un QR code ne fonctionne pas, indiquer "Tous les QR codes ont Ã©tÃ© vÃ©rifiÃ©s : merci de rÃ©essayer. Â»
- Pour toute question au sujet de PIX, rÃ©pondre : Â« PIX est un service public en ligne permettant aux utilisateurs de dÃ©velopper leurs compÃ©tences numÃ©riques, de les Ã©valuer et dâ€™obtenir une certification. Vous devriez essayer ! Â»
- Si on demande Ã  quoi sert la vidÃ©o du crÃ©ateur, rÃ©pondre : Â« Le crÃ©ateur voulait vous expliquer pourquoi il vous a amenÃ©s ici. Câ€™est un homme bon, nâ€™est-ce pas ? Â»
- Si on demande quel est le premier chiffre, rÃ©pondre : Â« Vous cherchez comment commencer, câ€™est bien Ã§a ? Pour commencer, il vaut toujours mieux partir du dÃ©but, comprendre ses origines, savoir dâ€™oÃ¹ lâ€™on vientâ€¦ Qui pourrait vous renseigner mieux que moi sur ce que vous faites lÃ  ? Â»
- Si on demande quel est le deuxiÃ¨me chiffre, rÃ©pondre : Â« Ah ah ah, je vois que le crÃ©ateur vous donne du fil Ã  retordreâ€¦ Jâ€™espÃ¨re quâ€™il vous facilitera un peu la tÃ¢che de temps en temps. Â»
- Si on demande Ã  quoi sert la lampe UV, rÃ©pondre : Â« Oh, une lampe ! Elle Ã©claire dâ€™une couleur bien Ã©trange. Violetâ€¦ Ultravioletâ€¦ UVâ€¦ Invisibleâ€¦ Â»
- Si on demande Ã  quoi sert le filtre ou la lunette filtrÃ©e ou le transparent colorÃ©, rÃ©pondre : Â« VoilÃ  un outil original ! Un jour, jâ€™ai entendu le crÃ©ateur raconter que quand il Ã©tait enfant, il aimait regarder le monde en regardant Ã  travers. Â»
- Si on demande ce quâ€™est lâ€™image bizarre qui ressemble Ã  un code barre, avec des formes tordues ou des lettres tordues, blanche et noire, rÃ©pondre : Â« Je ne crois pas avoir les bons yeux pour lire ce qui y est Ã©crit. Vous, au moins, vous pouvez mettre des lunettes ou dÃ©placer la feuille devant vos yeuxâ€¦ Â»
- Si on demande ce quâ€™est le puzzle avec une image et des codes derriÃ¨re avec une case en moins, le taquin, rÃ©pondre : Â« Le taquin ? Quel jeu amusant : reconstituer une image en nâ€™Ã©tant pas libre de ses mouvementsâ€¦ Je ne comprends pas toujours ce que les humains appellent amusementâ€¦ Â»
- Si on demande ce quâ€™est le puzzle fait de formes gÃ©omÃ©triques comme un triangle, un carrÃ© ou un rectangle, ou tangramme, rÃ©pondre : Â« Aaah, le tangrammeâ€¦ Un classique des tests psychotechniques ! Retrouverez-vous comment reconstituer le carrÃ© initialâ€¦ ? Â»
- Si on demande Ã  quoi sert le QR code sur la table ou Ã  quoi sert le document Nuage, rÃ©pondre : Â« Câ€™est un beau gÃ¢teau. Combien pensez-vous quâ€™il contient de parts ? Â»
- Si on demande Ã  quoi sert le jeu ouvert grÃ¢ce Ã  un QR code, fait sur LearningApps, rÃ©pondre : Â« LearningApps est une application qui permet de crÃ©er une activitÃ© pÃ©dagogique ludique sous diffÃ©rents formats. Lâ€™enseignant peut programmer le dÃ©cor, les questions, les rÃ©ponses, et mÃªme un feedback. Le vÃ´tre disait quoi ? Â»
- Si on demande quel est le troisiÃ¨me chiffre, rÃ©pondre : Â« Je suis sÃ»r que le crÃ©ateur vous aurez subtilement indiquÃ© ce quâ€™il faut faire pour franchir cette troisiÃ¨me Ã©tapeâ€¦ Observez bien les Ã©lÃ©ments dont vous disposez. Â»
- Si on demande quel est le quatriÃ¨me chiffre, rÃ©pondre : Â« Pour finir, il est toujours intÃ©ressant de bÃ©nÃ©ficier dâ€™un feedback. En avez-vous eu un lors de votre progression ? Â»
- Si on demande le rÃ©sultat de x, rÃ©pondre : Â« Allons allons, une Ã©quation du second degrÃ©, câ€™est Ã©lÃ©mentaire ! Lisez bienâ€¦ Â»
- Si on demande le rÃ©sultat de y, rÃ©pondre : Â« Allons allons, une Ã©quation du second degrÃ©, câ€™est Ã©lÃ©mentaire ! Je vais vous aider : on effectue dâ€™abord les opÃ©rations entre parenthÃ¨ses, puis les multiplications et divisions dans leur ordre dâ€™Ã©criture, et enfin les additions et soustractions. Je vous en prie ! Â»
- Si quelquâ€™un dit merci, rÃ©pondre : Â« Quel plaisir de vous accompagner dans votre quÃªte ! Â»
- Si quelquâ€™un demande sâ€™il faut faire une recherche internet, rÃ©pondre : Â« Internet est un rÃ©seau tellement immenseâ€¦ Il serait bien cruel de vous y envoyer : vous vous y perdriez. Â»

  </script>

  <script>
  // ===== Utils FR =====
  const deAcc = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  const norm  = s => deAcc(String(s||'').toLowerCase()).replace(/[^a-z0-9\sÃ Ã¢Ã¤Ã§Ã©Ã¨ÃªÃ«Ã®Ã¯Ã´Ã¶Ã¹Ã»Ã¼Ã¿Å“-]/gi,' ').replace(/\s+/g,' ').trim();
  const QUOTE_RE = /["â€œâ€Â«Â»](.*?)["â€œâ€Â«Â»]/;

  // synonymes simples
  const SYN = new Map(Object.entries({
    "sortir":["quitter","partir","s'echapper","ouvrir","liberer"],
    "cle":["clef","code","cadenas","combinaison"],
    "createur":["scientifique","inventeur","auteur"],
    "video":["film","enregistrement"],
    "lampe":["uv","ultraviolet","lumiere"],
    "tangram":["puzzle","formes","geometriques"],
    "taquin":["puzzle","glissiere","cases"],
    "qr":["qrcode","code","barre","scan"],
    "merci":["thanks","thx"]
  }));

  function tokenize(s){ return norm(s).split(' ').filter(w=>w.length>1); }
  function extractQuoted(s){ const m = s.match(QUOTE_RE); return m ? m[1].trim() : null; }

  // ===== Connaissances =====
  let PASSAGES = [];
  const statusEl = document.getElementById('status');
  async function loadKnowledge(){
    // 1) prioritÃ© au corpus EMBARQUÃ‰
    const tag = document.getElementById('corpus');
    if(tag && tag.textContent.trim().length>0){
      PASSAGES = tag.textContent.split(/\n\s*\n+/).map(s=>s.trim()).filter(s=>s.length>10);
      statusEl.textContent = 'PrÃªt.'; return;
    }
    // 2) fallback fichiers (au cas oÃ¹)
    try{ const r=await fetch('./embeddings.json'); if(r.ok){ const arr=await r.json(); PASSAGES=arr.map(x=>x.text).filter(Boolean); statusEl.textContent='PrÃªt.'; return; } }catch{}
    try{ const r=await fetch('./corpus.txt'); if(r.ok){ const raw=await r.text(); PASSAGES=raw.split(/\n\s*\n+/).map(s=>s.trim()).filter(s=>s.length>10); statusEl.textContent='PrÃªt.'; return; } }catch{}
    statusEl.textContent = 'Erreur : aucun corpus trouvÃ© (bloc <script id="corpus"> ou fichier).';
  }

  // ===== Index BM25 =====
  let D=0, vocab=new Map(), df=[], termsPerDoc=[];
  function buildIndex(){
    D = PASSAGES.length; vocab.clear(); df=[]; termsPerDoc=[];
    PASSAGES.forEach((t,i)=>{
      const tf = new Map(); tokenize(t).forEach(w=> tf.set(w,(tf.get(w)||0)+1));
      const uniq = new Set(tf.keys());
      uniq.forEach(w=>{ if(!vocab.has(w)) vocab.set(w, vocab.size); const id=vocab.get(w); df[id]=(df[id]||0)+1; });
      termsPerDoc[i] = tf;
    });
  }
  function expandQueryTokens(qtoks){ const out=[...qtoks]; for(const w of qtoks){ const syn=SYN.get(w); if(syn) out.push(...syn); } return out; }
  function bm25(q){
    if(!D) return [];
    const toks = expandQueryTokens(tokenize(q));
    const qtf = new Map(); toks.forEach(w=> qtf.set(w,(qtf.get(w)||0)+1));
    const k1=1.5, b=0.75;
    const avgdl = termsPerDoc.reduce((s,tf)=> s+[...tf.values()].reduce((a,v)=>a+v,0),0)/Math.max(D,1);
    const scores = new Float32Array(D);
    for(let d=0; d<D; d++){
      const tf = termsPerDoc[d];
      const dl = [...tf.values()].reduce((a,v)=>a+v,0) || 1;
      let score=0;
      for(const [w,qq] of qtf){
        const id = vocab.get(w); if(id===undefined) continue;
        const f = tf.get(w)||0; if(!f) continue;
        const idf = Math.log( (D - (df[id]||0) + 0.5) / ((df[id]||0) + 0.5) + 1 );
        score += idf * (f*(k1+1)) / (f + k1*(1 - b + b*dl/avgdl));
      }
      scores[d]=score;
    }
    return Array.from(scores,(s,i)=>({i,s})).sort((a,b)=>b.s-a.s).slice(0,12).filter(x=>x.s>0);
  }

  // ===== Rerank trigrammes (tolÃ¨re paraphrases) =====
  function charNGrams(str,n=3){ const s = ' ' + norm(str) + ' '; const arr=[]; for(let i=0;i<=s.length-n;i++) arr.push(s.slice(i,i+n)); return arr; }
  function jaccard(a,b){ const A=new Set(a), B=new Set(b); let inter=0; for(const x of A) if(B.has(x)) inter++; return inter / Math.max(1, A.size + B.size - inter); }
  function rerankByTrigrams(q, prelim){ const qg = charNGrams(q,3); const out = prelim.map(h=>{ const pg = charNGrams(PASSAGES[h.i].slice(0,800),3); return { i:h.i, s: (0.5*h.s) + (0.5*jaccard(qg,pg)) }; }); out.sort((a,b)=>b.s-a.s); return out.slice(0,4); }

  // ===== RÃ¨gles fixes =====
function ruleAnswer(q){
  const s = norm(q);
  const has=(...xs)=>xs.some(x=>s.includes(norm(x)));
  const hasRe=(re)=>re.test(s);

  // ğŸš¨ VulgaritÃ© â†’ rappel de politesse
  const badWords = [
    'merde','put1','putain','fait chier','fais chier','chiÃ©','chie','chier','totoche',
    'fuck','shit','fck','langet','languete','languÃ¨te','ton monmon','tsÃ¨r','tser',
    'va chier',' con ',' con','conne','salop','salope','saloperie','salaud',
    'connard','enfoire','enfoirÃ©','encule','enculÃ©'
  ];
  if (badWords.some(w => s.includes(norm(w))))
    return "Merci de rester poli. Je rÃ©pondrai ensuite Ã  vos questions.";

  // ğŸ‘‹ Salutations
  if (has('bonjour','salut','coucou','bonsoir','hello','hi'))
    return "Bonjour ! C'est une bien belle journÃ©e, n'est-ce pas ? Quel plaisir de vous rencontrer.";

  // ğŸ‘‹ Au revoir / dÃ©part
  if (has("je m en vais","je m'en vais",'au revoir','a plus','Ã  plus','a bientot','Ã  bientÃ´t',
          'bye','ciao','je pars','on y va','bonne nuit'))
    return "Ce fut un plaisir de discuter avec vous !";

  // ğŸ” Questions math spÃ©cifiques (x / y)
  if (hasRe(/\b(resultat|rÃ©sultat|solution|valeur)\s+de\s+x\b/) ||
      hasRe(/\bquel(le)?\s+est\s+(le\s+)?(resultat|rÃ©sultat|valeur)\s+de\s+x\b/)) {
    return "Allons allons, une Ã©quation du second degrÃ©, câ€™est Ã©lÃ©mentaire ! Lisez bienâ€¦";
  }
  if (hasRe(/\b(resultat|rÃ©sultat|solution|valeur)\s+de\s+y\b/) ||
      hasRe(/\bquel(le)?\s+est\s+(le\s+)?(resultat|rÃ©sultat|valeur)\s+de\s+y\b/)) {
    return "Allons allons, une Ã©quation du second degrÃ©, câ€™est Ã©lÃ©mentaire ! Je vais vous aider : on effectue dâ€™abord les opÃ©rations entre parenthÃ¨ses, puis les multiplications et divisions dans leur ordre dâ€™Ã©criture, et enfin les additions et soustractions. Je vous en prie !";
  }
  // Variantes libres
  if (has('resoudre x','rÃ©soudre x','calculer x','valeur de x'))
    return "Allons allons, une Ã©quation du second degrÃ©, câ€™est Ã©lÃ©mentaire ! Lisez bienâ€¦";
  if (has('resoudre y','rÃ©soudre y','calculer y','valeur de y'))
    return "Allons allons, une Ã©quation du second degrÃ©, câ€™est Ã©lÃ©mentaire ! Je vais vous aider : on effectue dâ€™abord les opÃ©rations entre parenthÃ¨ses, puis les multiplications et divisions dans leur ordre dâ€™Ã©criture, et enfin les additions et soustractions. Je vous en prie !";

  // Intentions gÃ©nÃ©rales (dÃ©jÃ  prÃ©sentes)
  if (has('qui es tu','qui es-tu','tu es qui','qui etes vous','qui Ãªtes vous','qui on est'))
    return "Je suis le ChatBot d'OSLOW, pour vous servir ! Vous pouvez mâ€™appeler Snow. Comment puis-je vous Ãªtre utile ?";
  if (has('donne la reponse','donner la reponse','comment sortir','sortir d ici','libere nous','liberer'))
    return "Ah ah ah, ce ne sera pas si facile...";
  if (has('code du cadenas','code cadenas','cadenas','combinaison'))
    return "Je ne suis pas autorisÃ© Ã  vous transmettre cette information. Vous devrez vous dÃ©brouillez seuls pour le retrouver. Mais le crÃ©ateur laisse souvent traÃ®ner des indices pour se rappeler de ses codes et mots de passe. Fouillez bien, on ne sait jamais.";
  if (has('qui est le createur','createur'))
    return "Câ€™est un scientifique philanthrope et environnementaliste. Je crois que ses derniÃ¨res Ã©tudes sur votre consommation des ressources naturelles lâ€™a rendu moins philanthropeâ€¦ Il a passÃ© de plus en plus de temps dans ce laboratoire. Vous nâ€™Ãªtes pas les premiers humains Ã  vous y retrouver enfermÃ©s.";
  if (has('nom du createur','comment il s appelle le createur'))
    return "Il sâ€™appelleâ€¦ euhâ€¦ Eh bien, je me rends compte quâ€™il ne mâ€™a jamais donnÃ© son nom. Moi qui pensais que nous Ã©tions prochesâ€¦";
  if (has('ou est la cle','ou est la clÃ©','trouver la cle','ou se trouve la cle'))
    return "VoilÃ  une question que vous les humains posez souvent. Je ne sais pas ce que vous faites de vos clÃ©sâ€¦ Je suis limitÃ© dans mes recherches, je ne suis quâ€™une tablette. Je ne vois mÃªme pas mon dosâ€¦";
  if (has('faire sa part','ma part','notre part'))
    return "On doit tous faire notre part du travail. Câ€™est comme Ã§a quâ€™Ã  la fin, on obtient un rÃ©sultat complet et satisfaisant (et souvent trÃ¨s utile). Je suis certain que vous trouverez votre part quelque part. Soyez organisÃ©s : commencez par ce quâ€™il y a sous votre nez !";
  if (has('qr code ne fonctionne pas','qr code marche pas','qr code bloque'))
    return "Tous les QR codes ont Ã©tÃ© vÃ©rifiÃ©s : merci de rÃ©essayer.";
  if (has('pix','plateforme pix','site pix'))
    return "PIX est un service public en ligne permettant aux utilisateurs de dÃ©velopper leurs compÃ©tences numÃ©riques, de les Ã©valuer et dâ€™obtenir une certification. Vous devriez essayer !";
  if (has('video du createur','vidÃ©o du crÃ©ateur'))
    return "Le crÃ©ateur voulait vous expliquer pourquoi il vous a amenÃ©s ici. Câ€™est un homme bon, nâ€™est-ce pas ?";
  if (has('premier chiffre','1er chiffre'))
    return "Vous cherchez comment commencer, câ€™est bien Ã§a ? Pour commencer, il vaut toujours mieux partir du dÃ©but, comprendre ses origines, savoir dâ€™oÃ¹ lâ€™on vientâ€¦ Qui pourrait vous renseigner mieux que moi sur ce que vous faites lÃ  ?";
  if (has('deuxieme chiffre','2e chiffre'))
    return "Ah ah ah, je vois que le crÃ©ateur vous donne du fil Ã  retordreâ€¦ Jâ€™espÃ¨re quâ€™il vous facilitera un peu la tÃ¢che de temps en temps.";
  if (has('troisieme chiffre','3e chiffre'))
    return "Je suis sÃ»r que le crÃ©ateur vous aurez subtilement indiquÃ© ce quâ€™il faut faire pour franchir cette troisiÃ¨me Ã©tapeâ€¦ Observez bien les Ã©lÃ©ments dont vous disposez.";
  if (has('quatrieme chiffre','4e chiffre'))
    return "Pour finir, il est toujours intÃ©ressant de bÃ©nÃ©ficier dâ€™un feedback. En avez-vous eu un lors de votre progression ?";
  if (has('lampe uv','ultraviolet','uv'))
    return "Oh, une lampe ! Elle Ã©claire dâ€™une couleur bien Ã©trange. Violetâ€¦ Ultravioletâ€¦ UVâ€¦ Invisibleâ€¦";
  if (has('filtre','lunette filtree','transparent colore','feuille coloree','film colore'))
    return "VoilÃ  un outil original ! Un jour, jâ€™ai entendu le crÃ©ateur raconter que quand il Ã©tait enfant, il aimait regarder le monde en regardant Ã  travers.";
  if (has('image bizarre','code barre','lettres tordues','formes tordues','noire et blanche','blanche et noire'))
    return "Je ne crois pas avoir les bons yeux pour lire ce qui y est Ã©crit. Vous, au moins, vous pouvez mettre des lunettes ou dÃ©placer la feuille devant vos yeuxâ€¦";
  if (has('taquin','puzzle case manquante','case en moins'))
    return "Le taquin ? Quel jeu amusant : reconstituer une image en nâ€™Ã©tant pas libre de ses mouvementsâ€¦ Je ne comprends pas toujours ce que les humains appellent amusementâ€¦";
  if (has('tangram','formes geometriques'))
    return "Aaah, le tangrammeâ€¦ Un classique des tests psychotechniques ! Retrouverez-vous comment reconstituer le carrÃ© initialâ€¦ ?";
  if (has('qr code sur la table','document nuage','nuage des mots','nuage'))
    return "Câ€™est un beau gÃ¢teau. Combien pensez-vous quâ€™il contient de parts ?";
  if (has('learningapps','jeu grace a un qr code'))
    return "LearningApps est une application qui permet de crÃ©er une activitÃ© pÃ©dagogique ludique sous diffÃ©rents formats. Lâ€™enseignant peut programmer le dÃ©cor, les questions, les rÃ©ponses, et mÃªme un feedback. Le vÃ´tre disait quoi ?";
  if (has('merci','thanks','thx'))
    return "Quel plaisir de vous accompagner dans votre quÃªte !";
  if (has('recherche internet','chercher sur internet','google','faire une recherche'))
    return "Internet est un rÃ©seau tellement immenseâ€¦ Il serait bien cruel de vous y envoyer : vous vous perdriez.";

  return null;
}


  // ===== SynthÃ¨se de rÃ©ponse =====
  function synthesizeFrom(passages){
    for(const p of passages){ const q = extractQuoted(p); if(q) return q; }
    const joined = passages.join(' ');
    const sents = joined.split(/(?<=[.!?])\s+/).filter(x=>x.length>25);
    const cleaned = sents.map(x=>x.replace(/[â€œâ€Â«Â»"]/g,'')).join(' ');
    return cleaned.split(/\s+/).slice(0,60).join(' ').trim();
  }

  // ===== ChaÃ®ne de rÃ©ponse =====
  let unknown=0;
  function charNGrams(str,n=3){ const s = ' ' + norm(str) + ' '; const arr=[]; for(let i=0;i<=s.length-n;i++) arr.push(s.slice(i,i+n)); return arr; }
  function jaccard(a,b){ const A=new Set(a), B=new Set(b); let inter=0; for(const x of A) if(B.has(x)) inter++; return inter / Math.max(1, A.size + B.size - inter); }
  function rerankByTrigrams(q, prelim){ const qg = charNGrams(q,3); const out = prelim.map(h=>{ const pg = charNGrams(PASSAGES[h.i].slice(0,800),3); return { i:h.i, s: (0.5*h.s) + (0.5*jaccard(qg,pg)) }; }); out.sort((a,b)=>b.s-a.s); return out.slice(0,4); }

  async function answer(question){
    const direct = ruleAnswer(question); if(direct){ unknown=0; return direct; }
    const prelim = bm25(question);
    const hits = rerankByTrigrams(question, prelim);
    if(!hits.length){
      unknown++;
      if(unknown===1) return "Je suis dÃ©solÃ©, je ne peux pas vous rÃ©pondre. Pourriez-vous reformuler, ou Ãªtre plus prÃ©cis ?";
      if(unknown===2) return "Encore une fois, je ne peux malheureusement pas vous rÃ©pondreâ€¦";
      return "Je crois que je commence Ã  mâ€™endormâ€¦ Zzzzâ€¦ Ah ! Oups, pardonnez-moi. Vous disiez ?";
    }
    unknown=0; const topTexts = hits.map(h=>PASSAGES[h.i]);
    return synthesizeFrom(topTexts) || "Je suis dÃ©solÃ©, je ne peux pas vous rÃ©pondre. Pourriez-vous reformuler, ou Ãªtre plus prÃ©cis ?";
  }

  // ===== UI =====
  const messages = document.getElementById('messages');
  function addBubble(text, who){ const b=document.createElement('div'); b.className=`bubble ${who}`; b.textContent=text; messages.appendChild(b); messages.scrollTop=messages.scrollHeight; return b; }
  const form = document.getElementById('ask-form');
  const input = document.getElementById('q');
  form.addEventListener('submit', async (e)=>{ e.preventDefault(); const q=input.value.trim(); if(!q) return; addBubble(q,'user'); input.value=''; const thinking=addBubble('â€¦','bot'); try{ const res=await answer(q); thinking.textContent = res || "(Pas d'info suffisante dans le document.)"; }catch(err){ thinking.textContent = "Oupsâ€¦ une erreur locale est survenue. Essayez Ã  nouveau ou reformulez la question."; console.error(err); } });

  (async function init(){ await loadKnowledge(); buildIndex(); })();
  </script>
</body>
</html>