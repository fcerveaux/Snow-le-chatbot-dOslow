<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Snow ‚Äî Chatbot d'OSLOW (ultra-stable)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Kaisei+Decol:wght@700&display=swap" rel="stylesheet">
  <style>
    :root{ --rose-bg:#f7e6ec; --rose-100:#fdeff4; --rose-200:#f9dbe6; --rose-300:#f2c3d6; --rose-400:#e3a7c3; --text:#3f2d38; --muted:#6a4f5b; --white:#fff; --radius:18px; --shadow:0 10px 30px rgba(100,60,80,.15) }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--text);
      background: radial-gradient(1200px 800px at 10% -10%, var(--rose-200), transparent), radial-gradient(1200px 800px at 110% 10%, var(--rose-100), transparent), var(--rose-bg);
      display:flex; flex-direction:column}
    header{max-width:900px; margin:24px auto 0; padding:0 16px}
    .brand{display:flex; align-items:center; gap:14px}
    .avatar{width:52px; height:52px; border-radius:50%; background:linear-gradient(135deg, var(--rose-400), var(--rose-200)); box-shadow:var(--shadow); position:relative}
    .avatar:before,.avatar:after{content:""; position:absolute; background:var(--white)}
    .avatar:before{width:18px;height:18px;border-radius:50%; top:18px; left:12px; box-shadow:24px 0 0 var(--white)}
    .avatar:after{width:16px;height:10px;border-radius:10px 10px 0 0; bottom:10px; left:18px; box-shadow:20px 0 0 var(--white)}
    .title{font-family:"Kaisei Decol",serif; font-weight:700; font-size:28px}
    .subtitle{color:var(--muted); font-size:14px; margin-top:2px}
    main{flex:1; display:flex}
    .container{max-width:900px; width:100%; margin:16px auto; padding:0 16px; display:grid; grid-template-rows:auto 1fr auto; gap:16px}
    .chatbox{background:var(--white); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; display:flex; flex-direction:column; gap:16px; min-height:55vh; border:1px solid rgba(100,60,80,.08)}
    .messages{display:flex; flex-direction:column; gap:12px; overflow:auto; padding:6px}
    .bubble{max-width:80%; padding:12px 14px; border-radius:16px; line-height:1.45; font-size:15px; box-shadow:0 4px 16px rgba(60,30,40,.06)}
    .user{align-self:flex-end; background:var(--rose-300); color:#3b2431; border:1px solid rgba(100,60,80,.15)}
    .bot{align-self:flex-start; background:#fff; border:1px solid rgba(100,60,80,.12)}
    form.ask{display:flex; gap:10px; align-items:center; background: var(--white); padding:10px; border-radius: var(--radius); box-shadow: var(--shadow); border:1px solid rgba(100,60,80,.08)}
    .input{flex:1; background:#fff; border:1px solid rgba(100,60,80,.18); padding:12px 14px; border-radius:12px; font-size:15px; outline:none}
    .btn{background:linear-gradient(135deg,var(--rose-400),var(--rose-300)); color:#3f1630; border:none; padding:12px 14px; border-radius:14px; font-weight:700; cursor:pointer; box-shadow:0 6px 18px rgba(227,167,195,.35)}
    footer{max-width:900px; margin:0 auto 24px; padding:0 16px; color:var(--muted); font-size:12px; text-align:center}
    .hint{font-size:12px; color:var(--muted); text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="avatar" aria-hidden="true"></div>
      <div>
        <div class="title">Snow <span aria-hidden="true">üêæ</span></div>
        <div class="subtitle">Chatbot d'OSLOW</div>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="chatbox" role="region" aria-live="polite">
        <div id="messages" class="messages">
          <div class="bubble bot">Bonjour ! Je suis Snow. Pose-moi une question üôÇ</div>
        </div>
        <div class="hint" id="status">Pr√©paration‚Ä¶</div>
      </div>

      <form class="ask" id="ask-form">
        <input id="q" class="input" placeholder="Votre question‚Ä¶" autocomplete="off" />
        <button class="btn" type="submit">Envoyer</button>
      </form>
    </div>
  </main>

  <footer>
    <span class="hint">Confidentialit√© : tout se passe dans votre navigateur. Aucune donn√©e n'est envoy√©e ni stock√©e une fois l'onglet ferm√©.</span>
  </footer>

  <script>
  // ============ Utilitaires FR =============
  const deAcc = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  const norm  = s => deAcc(String(s||'').toLowerCase())
                      .replace(/[^a-z0-9\s√†√¢√§√ß√©√®√™√´√Æ√Ø√¥√∂√π√ª√º√ø≈ì-]/gi,' ')
                      .replace(/\s+/g,' ').trim();

  // synonymes simples pour √©largir la requ√™te
  const SYN = new Map(Object.entries({
    "sortir":["quitter","partir","s'echapper","ouvrir","liberer"],
    "cle":["clef","code","cadenas","combinaison"],
    "createur":["scientifique","inventeur","auteur"],
    "video":["film","enregistrement"],
    "lampe":["uv","ultraviolet","lumiere"],
    "tangram":["puzzle","formes","geometriques"],
    "taquin":["puzzle","glissiere","cases"],
    "qr":["qrcode","code","barre","scan"],
    "merci":["thanks","thx"]
  }));

  function tokenize(s){ return norm(s).split(' ').filter(w=>w.length>1); }

  // ============ Chargement du corpus ============
  let PASSAGES = [];
  const statusEl = document.getElementById('status');
  async function loadKnowledge(){
    try{
      let ok=false;
      try{
        const r=await fetch('./embeddings.json');
        if(r.ok){ const arr = await r.json(); PASSAGES = arr.map(x=>x.text).filter(Boolean); ok=true; }
      }catch{}
      if(!ok){
        const r = await fetch('./corpus.txt');
        if(r.ok){
          const raw = await r.text();
          // split en blocs (deux sauts de ligne) + nettoyage
          PASSAGES = raw.split(/\n\s*\n+/).map(s=>s.trim()).filter(s=>s.length>10);
          ok=true;
        }
      }
      statusEl.textContent = ok ? "Pr√™t." : "Erreur : corpus introuvable (mettez corpus.txt √† la racine).";
    }catch{
      statusEl.textContent = "Pr√™t (mode minimal).";
    }
  }

  // ============ Index BM25 l√©ger ============
  let D=0, vocab=new Map(), df=[], termsPerDoc=[];
  function buildIndex(){
    D = PASSAGES.length; vocab.clear(); df=[]; termsPerDoc=[];
    PASSAGES.forEach((t,i)=>{
      const tf = new Map();
      tokenize(t).forEach(w=> tf.set(w, (tf.get(w)||0)+1 ));
      const uniq = new Set(tf.keys());
      uniq.forEach(w=>{
        if(!vocab.has(w)) vocab.set(w, vocab.size);
        const id = vocab.get(w);
        df[id] = (df[id]||0)+1;
      });
      termsPerDoc[i] = tf;
    });
  }
  function expandQueryTokens(qtoks){
    const out = [...qtoks];
    for(const w of qtoks){ const syn = SYN.get(w); if(syn) out.push(...syn); }
    return out;
  }
  function bm25(q){
    if(!D) return [];
    const toks = expandQueryTokens(tokenize(q));
    const qtf = new Map(); toks.forEach(w=> qtf.set(w, (qtf.get(w)||0)+1));
    const k1=1.5, b=0.75;
    const avgdl = termsPerDoc.reduce((s,tf)=> s+[...tf.values()].reduce((a,v)=>a+v,0),0)/Math.max(D,1);
    const scores = new Float32Array(D);
    for(let d=0; d<D; d++){
      const tf = termsPerDoc[d];
      const dl = [...tf.values()].reduce((a,v)=>a+v,0) || 1;
      let score=0;
      for(const [w,qq] of qtf){
        const id = vocab.get(w); if(id===undefined) continue;
        const f = tf.get(w)||0; if(!f) continue;
        const idf = Math.log( (D - (df[id]||0) + 0.5) / ((df[id]||0) + 0.5) + 1 );
        score += idf * (f*(k1+1)) / (f + k1*(1 - b + b*dl/avgdl));
      }
      scores[d]=score;
    }
    return Array.from(scores,(s,i)=>({i,s})).sort((a,b)=>b.s-a.s).slice(0,12).filter(x=>x.s>0);
  }

  // ============ Similarit√© trigrammes (tol√®re paraphrases) ============
  function charNGrams(str,n=3){
    const s = ' ' + norm(str) + ' ';
    const arr=[]; for(let i=0;i<=s.length-n;i++) arr.push(s.slice(i,i+n));
    return arr;
  }
  function jaccard(a,b){
    const A=new Set(a), B=new Set(b);
    let inter=0; for(const x of A) if(B.has(x)) inter++;
    return inter / Math.max(1, A.size + B.size - inter);
    }
  function rerankByTrigrams(q, prelim){
    const qg = charNGrams(q,3);
    const scored = prelim.map(h=>{
      const pg = charNGrams(PASSAGES[h.i].slice(0,800),3);
      return { i:h.i, s: (0.5*h.s) + (0.5*jaccard(qg,pg)) };
    });
    scored.sort((a,b)=>b.s-a.s);
    return scored.slice(0,4);
  }

  // ============ R√®gles fixes (intent rapide) ============
  function ruleAnswer(q){
    const s = norm(q);
    const has=(...xs)=>xs.some(x=>s.includes(norm(x)));
    if (has('qui es tu','qui es-tu','tu es qui','qui etes vous','qui √™tes vous','qui on est'))
      return "Je suis le ChatBot d'OSLOW, pour vous servir ! Vous pouvez m‚Äôappeler Snow. Comment puis-je vous √™tre utile ?";
    if (has('donne la reponse','donner la reponse','comment sortir','sortir d ici','libere nous','liberer'))
      return "Ah ah ah, ce ne sera pas si facile...";
    if (has('code du cadenas','code cadenas','cadenas','combinaison'))
      return "Je ne suis pas autoris√© √† vous transmettre cette information. Vous devrez vous d√©brouillez seuls pour le retrouver. Mais le cr√©ateur laisse souvent tra√Æner des indices pour se rappeler de ses codes et mots de passe. Fouillez bien, on ne sait jamais.";
    if (has('qui est le createur','createur','createur ?'))
      return "C‚Äôest un scientifique philanthrope et environnementaliste. Je crois que ses derni√®res √©tudes sur votre consommation des ressources naturelles l‚Äôa rendu moins philanthrope‚Ä¶ Il a pass√© de plus en plus de temps dans ce laboratoire. Vous n‚Äô√™tes pas les premiers humains √† vous y retrouver enferm√©s.";
    if (has('nom du createur','comment il s appelle le createur'))
      return "Il s‚Äôappelle‚Ä¶ euh‚Ä¶ Eh bien, je me rends compte qu‚Äôil ne m‚Äôa jamais donn√© son nom. Moi qui pensais que nous √©tions proches‚Ä¶";
    if (has('ou est la cle','ou est la cl√©','trouver la cle','ou se trouve la cle'))
      return "Voil√† une question que vous les humains posez souvent. Je ne sais pas ce que vous faites de vos cl√©s‚Ä¶ Je suis limit√© dans mes recherches, je ne suis qu‚Äôune tablette. Je ne vois m√™me pas mon dos‚Ä¶";
    if (has('faire sa part','ma part','notre part'))
      return "On doit tous faire notre part du travail. C‚Äôest comme √ßa qu‚Äô√† la fin, on obtient un r√©sultat complet et satisfaisant (et souvent tr√®s utile). Je suis certain que vous trouverez votre part quelque part. Soyez organis√©s : commencez par ce qu‚Äôil y a sous votre nez !";
    if (has('qr code ne fonctionne pas','qr code marche pas','qr code bloque'))
      return "Tous les QR codes ont √©t√© v√©rifi√©s : merci de r√©essayer.";
    if (has('pix','plateforme pix','site pix'))
      return "PIX est un service public en ligne permettant aux utilisateurs de d√©velopper leurs comp√©tences num√©riques, de les √©valuer et d‚Äôobtenir une certification. Vous devriez essayer !";
    if (has('video du createur','vid√©o du cr√©ateur'))
      return "Le cr√©ateur voulait vous expliquer pourquoi il vous a amen√©s ici. C‚Äôest un homme bon, n‚Äôest-ce pas ?";
    if (has('premier chiffre','1er chiffre'))
      return "Vous cherchez comment commencer, c‚Äôest bien √ßa ? Pour commencer, il vaut toujours mieux partir du d√©but, comprendre ses origines, savoir d‚Äôo√π l‚Äôon vient‚Ä¶ Qui pourrait vous renseigner mieux que moi sur ce que vous faites l√† ?";
    if (has('deuxieme chiffre','2e chiffre'))
      return "Ah ah ah, je vois que le cr√©ateur vous donne du fil √† retordre‚Ä¶ J‚Äôesp√®re qu‚Äôil vous facilitera un peu la t√¢che de temps en temps.";
    if (has('troisieme chiffre','3e chiffre'))
      return "Je suis s√ªr que le cr√©ateur vous aurez subtilement indiqu√© ce qu‚Äôil faut faire pour franchir cette troisi√®me √©tape‚Ä¶ Observez bien les √©l√©ments dont vous disposez.";
    if (has('quatrieme chiffre','4e chiffre'))
      return "Pour finir, il est toujours int√©ressant de b√©n√©ficier d‚Äôun feedback. En avez-vous eu un lors de votre progression ?";
    if (has('lampe uv','ultraviolet','uv'))
      return "Oh, une lampe ! Elle √©claire d‚Äôune couleur bien √©trange. Violet‚Ä¶ Ultraviolet‚Ä¶ UV‚Ä¶ Invisible‚Ä¶";
    if (has('filtre','lunette filtree','transparent colore','feuille coloree','film colore'))
      return "Voil√† un outil original ! Un jour, j‚Äôai entendu le cr√©ateur raconter que quand il √©tait enfant, il aimait regarder le monde en regardant √† travers.";
    if (has('image bizarre','code barre','lettres tordues','formes tordues','noire et blanche','blanche et noire'))
      return "Je ne crois pas avoir les bons yeux pour lire ce qui y est √©crit. Vous, au moins, vous pouvez mettre des lunettes ou d√©placer la feuille devant vos yeux‚Ä¶";
    if (has('taquin','puzzle case manquante','case en moins'))
      return "Le taquin ? Quel jeu amusant : reconstituer une image en n‚Äô√©tant pas libre de ses mouvements‚Ä¶ Je ne comprends pas toujours ce que les humains appellent amusement‚Ä¶";
    if (has('tangram','formes geometriques'))
      return "Aaah, le tangramme‚Ä¶ Un classique des tests psychotechniques ! Retrouverez-vous comment reconstituer le carr√© initial‚Ä¶ ?";
    if (has('qr code sur la table','document nuage','nuage des mots','nuage'))
      return "C‚Äôest un beau g√¢teau. Combien pensez-vous qu‚Äôil contient de parts ?";
    if (has('learningapps','jeu grace a un qr code'))
      return "LearningApps est une application qui permet de cr√©er une activit√© p√©dagogique ludique sous diff√©rents formats. L‚Äôenseignant peut programmer le d√©cor, les questions, les r√©ponses, et m√™me un feedback. Le v√¥tre disait quoi ?";
    if (has('merci','thanks','thx'))
      return "Quel plaisir de vous accompagner dans votre qu√™te !";
    if (has('recherche internet','chercher sur internet','google','faire une recherche'))
      return "Internet est un r√©seau tellement immense‚Ä¶ Il serait bien cruel de vous y envoyer : vous vous perdriez.";
    return null;
  }

  // ============ G√©n√©ration de r√©ponse (sans LLM) ============
  const QUOTE_RE = /["‚Äú‚Äù¬´¬ª](.*?)["‚Äú‚Äù¬´¬ª]/;
  function extractQuoted(s){ const m = s.match(QUOTE_RE); return m ? m[1].trim() : null; }

  function synthesizeFrom(passages){
    // 1) si une r√©plique est entre guillemets quelque part ‚Üí on renvoie exactement √ßa
    for(const p of passages){ const q = extractQuoted(p); if(q) return q; }
    // 2) sinon on extrait 1‚Äì2 phrases ‚Äúporteuses‚Äù (pas de copier integral)
    const joined = passages.join(' ');
    const sents = joined.split(/(?<=[.!?])\s+/).filter(x=>x.length>25);
    // on √¥te guillemets ‚Äú ‚Äù
    const cleaned = sents.map(x=>x.replace(/[‚Äú‚Äù¬´¬ª"]/g,'')).join(' ');
    // on prend ~50‚Äì60 mots max
    return cleaned.split(/\s+/).slice(0,60).join(' ').trim();
  }

  let unknown=0;
  async function answer(question){
    // 0) r√®gles directes
    const direct = ruleAnswer(question);
    if(direct){ unknown=0; return direct; }

    // 1) recherche BM25
    const prelim = bm25(question);
    // 2) rerank trigrammes (tol√®re paraphrases)
    const hits = rerankByTrigrams(question, prelim);

    if(!hits.length){
      unknown++;
      if(unknown===1) return "Je suis d√©sol√©, je ne peux pas vous r√©pondre. Pourriez-vous reformuler, ou √™tre plus pr√©cis ?";
      if(unknown===2) return "Encore une fois, je ne peux malheureusement pas vous r√©pondre‚Ä¶";
      return "Je crois que je commence √† m‚Äôendorm‚Ä¶ Zzzz‚Ä¶ Ah ! Oups, pardonnez-moi. Vous disiez ?";
    }

    unknown=0;
    const topTexts = hits.map(h=>PASSAGES[h.i]);
    return synthesizeFrom(topTexts) || "Je suis d√©sol√©, je ne peux pas vous r√©pondre. Pourriez-vous reformuler, ou √™tre plus pr√©cis ?";
  }

  // ============ UI =============
  const messages = document.getElementById('messages');
  function addBubble(text, who){
    const b = document.createElement('div');
    b.className = `bubble ${who}`;
    b.textContent = text;
    messages.appendChild(b);
    messages.scrollTop = messages.scrollHeight;
    return b;
  }

  const form = document.getElementById('ask-form');
  const input = document.getElementById('q');

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const q = input.value.trim(); if(!q) return;
    addBubble(q,'user'); input.value='';
    const thinking = addBubble('‚Ä¶','bot');
    try{
      const res = await answer(q);
      thinking.textContent = res || "(Pas d'info suffisante dans le document.)";
    }catch(err){
      // pas de crash visible
      thinking.textContent = "Oups‚Ä¶ une erreur locale est survenue. Essayez √† nouveau ou reformulez la question.";
      console.error(err);
    }
  });

  (async function init(){
    await loadKnowledge();
    buildIndex();
  })();
  </script>
</body>
</html>
