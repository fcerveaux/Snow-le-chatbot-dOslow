<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Snow ‚Äî Chat (FR uniquement, LLM local + r√®gles)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Kaisei+Decol:wght@700&display=swap" rel="stylesheet">
  <style>
    :root{ --rose-bg:#f7e6ec; --rose-100:#fdeff4; --rose-200:#f9dbe6; --rose-300:#f2c3d6; --rose-400:#e3a7c3; --text:#3f2d38; --muted:#6a4f5b; --white:#fff; --radius:18px; --shadow:0 10px 30px rgba(100,60,80,.15) }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--text);
      background: radial-gradient(1200px 800px at 10% -10%, var(--rose-200), transparent), radial-gradient(1200px 800px at 110% 10%, var(--rose-100), transparent), var(--rose-bg);
      display:flex; flex-direction:column}
    header{max-width:900px; margin:24px auto 0; padding:0 16px}
    .brand{display:flex; align-items:center; gap:14px}
    .avatar{width:52px; height:52px; border-radius:50%; background:linear-gradient(135deg, var(--rose-400), var(--rose-200)); box-shadow:var(--shadow); position:relative}
    .avatar:before,.avatar:after{content:""; position:absolute; background:var(--white)}
    .avatar:before{width:18px;height:18px;border-radius:50%; top:18px; left:12px; box-shadow:24px 0 0 var(--white)}
    .avatar:after{width:16px;height:10px;border-radius:10px 10px 0 0; bottom:10px; left:18px; box-shadow:20px 0 0 var(--white)}
    .title{font-family:"Kaisei Decol",serif; font-weight:700; font-size:28px}
    .subtitle{color:var(--muted); font-size:14px; margin-top:2px}

    main{flex:1; display:flex}
    .container{max-width:900px; width:100%; margin:16px auto; padding:0 16px; display:grid; grid-template-rows:auto 1fr auto; gap:16px}

    .notice{font-size:12px; color:var(--muted)}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .badge{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:rgba(227,167,195,.28); border:1px solid rgba(100,60,80,.12)}

    .chatbox{background:var(--white); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; display:flex; flex-direction:column; gap:16px; min-height:55vh; border:1px solid rgba(100,60,80,.08)}
    .messages{display:flex; flex-direction:column; gap:12px; overflow:auto; padding:6px}
    .bubble{max-width:80%; padding:12px 14px; border-radius:16px; line-height:1.45; font-size:15px; box-shadow:0 4px 16px rgba(60,30,40,.06)}
    .user{align-self:flex-end; background:var(--rose-300); color:#3b2431; border:1px solid rgba(100,60,80,.15)}
    .bot{align-self:flex-start; background:#fff; border:1px solid rgba(100,60,80,.12)}

    form.ask{display:flex; gap:10px; align-items:center; background: var(--white); padding:10px; border-radius: var(--radius); box-shadow: var(--shadow); border:1px solid rgba(100,60,80,.08)}
    .input{flex:1; background:#fff; border:1px solid rgba(100,60,80,.18); padding:12px 14px; border-radius:12px; font-size:15px; outline:none}
    .btn{background:linear-gradient(135deg,var(--rose-400),var(--rose-300)); color:#3f1630; border:none; padding:12px 14px; border-radius:14px; font-weight:700; cursor:pointer; box-shadow:0 6px 18px rgba(227,167,195,.35)}

    footer{max-width:900px; margin:0 auto 24px; padding:0 16px; color:var(--muted); font-size:12px; text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="avatar" aria-hidden="true"></div>
      <div>
        <div class="title">Snow <span aria-hidden="true">üêæ</span></div>
        <div class="subtitle">FR uniquement ¬∑ R√®gles du document appliqu√©es ¬∑ Rien n'est stock√©.</div>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="row">
        <button id="load-llm" class="btn" type="button">Activer le mode Chat</button>
        <span id="llm-state" class="badge">LLM : inactif</span>
        <span class="badge">Aucune donn√©e stock√©e</span>
      </div>

      <div class="chatbox" role="region" aria-live="polite">
        <div id="messages" class="messages">
          <div class="bubble bot">Bonjour ! Je suis Snow. Pose-moi une question üôÇ</div>
        </div>
        <div class="notice" id="status">Chargement des connaissances‚Ä¶</div>
        <details class="notice"><summary>Diagnostic</summary><div id="diag">‚Äî</div><pre id="debug" style="white-space:pre-wrap;display:none"></pre></details>
      </div>

      <form class="ask" id="ask-form">
        <input id="q" class="input" placeholder="Votre question‚Ä¶" autocomplete="off" />
        <button class="btn" type="submit">Envoyer</button>
      </form>
    </div>
  </main>

  <footer>
    <span class="badge">Confidentialit√© : tout se passe dans votre navigateur. Aucune donn√©e n'est envoy√©e ni stock√©e une fois l'onglet ferm√©.</span>
  </footer>

  <script type="module">
    const messages = document.getElementById('messages');
    const statusEl = document.getElementById('status');
    const diag = document.getElementById('diag');
    const debugEl = document.getElementById('debug');
    const form = document.getElementById('ask-form');
    const input = document.getElementById('q');
    const btnLLM = document.getElementById('load-llm');
    const llmState = document.getElementById('llm-state');

    function addBubble(text, who){
      const b = document.createElement('div');
      b.className = `bubble ${who}`;
      b.textContent = text;
      messages.appendChild(b);
      messages.scrollTop = messages.scrollHeight;
      return b;
    }

    // 1) Charger connaissances (embeddings.json ou corpus.txt)
    let docs = [];
    async function loadKnowledge(){
      const tried = [];
      async function tryJSON(url){ try{ const r=await fetch(url); if(!r.ok) throw new Error(r.status); const kb=await r.json(); return kb.map(x=>x.text).filter(Boolean);}catch(e){ tried.push(`JSON ${url} -> ${e.message||e}`); return null; } }
      async function tryTXT(url){ try{ const r=await fetch(url); if(!r.ok) throw new Error(r.status); const raw=await r.text(); return raw.split(/\n\n+/).map(s=>s.trim()).filter(s=>s.length>10);}catch(e){ tried.push(`TXT ${url} -> ${e.message||e}`); return null; } }
      docs = await tryJSON('./embeddings.json') || await tryTXT('./corpus.txt') || [];
      if(!docs.length){ statusEl.textContent = "Erreur : aucune connaissance trouv√©e."; debugEl.style.display='block'; debugEl.textContent = tried.join('\n'); throw new Error('No knowledge'); }
      statusEl.textContent = `Connaissances pr√™tes (${docs.length} passages).`;
      diag.textContent = `Passages: ${docs.length}`;
    }

    // 2) Index TF-IDF (recherche) ‚Äî sans jamais afficher les sources
    const stripAccents = (s)=>s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    function tokenize(s){ return stripAccents(s.toLowerCase()).replace(/[^a-z0-9\s√†√¢√§√ß√©√®√™√´√Æ√Ø√¥√∂√π√ª√º√ø≈ì-]/gi,' ').split(/\s+/).filter(w=>w.length>1); }
    let vocab=new Map(), df=[], D=0, docTerms=[];
    function buildIndex(){
      D = docs.length; vocab.clear(); df=[]; docTerms=[];
      docs.forEach((text,i)=>{
        const terms = tokenize(text); const tf = new Map(); terms.forEach(w=>tf.set(w,(tf.get(w)||0)+1));
        const unique = new Set(terms); unique.forEach(w=>{ if(!vocab.has(w)) vocab.set(w,vocab.size); const id=vocab.get(w); df[id]=(df[id]||0)+1; });
        docTerms[i]=tf;
      });
      diag.textContent += `\nIndex: ${vocab.size} termes.`;
    }
    function scoreQuery(q){
      const qtf=new Map(); tokenize(q).forEach(w=>qtf.set(w,(qtf.get(w)||0)+1));
      const qVec=new Map(); for(const [w,f] of qtf){ const id=vocab.get(w); if(id===undefined) continue; const idf=Math.log((D+1)/((df[id]||0)+1))+1; qVec.set(id,f*idf); }
      const qNorm=Math.sqrt(Array.from(qVec.values()).reduce((s,v)=>s+v*v,0))||1;
      const scores=new Array(D).fill(0);
      for(let d=0; d<D; d++){
        let dot=0,dnorm=0; for(const [w,f] of docTerms[d]){ const id=vocab.get(w); if(id===undefined) continue; const idf=Math.log((D+1)/((df[id]||0)+1))+1; const val=f*idf; dnorm+=val*val; const qv=qVec.get(id); if(qv) dot+=qv*val; }
        dnorm=Math.sqrt(dnorm)||1; scores[d]=dot/(qNorm*dnorm);
      }
      return Array.from(scores.map((s,i)=>({i,s}))).sort((a,b)=>b.s-a.s).slice(0,4);
    }

    await loadKnowledge();
    buildIndex();

    // 3) Couche r√®gles (d√©termination directe)
    let unknownStreak = 0;
    function ruleAnswer(q){
      const s = q.normalize('NFD').toLowerCase();
      const has = (...xs)=>xs.some(x=>s.includes(x));
      if (has('qui es-tu','tu es qui','qui √™tes-vous','qui on est','qui es tu','qui etes vous','qui es vous'))
        return "Je suis le ChatBot d'OSLOW, pour vous servir ! Vous pouvez m‚Äôappeler Snow. Comment puis-je vous √™tre utile ?";
      if (has('donne la r√©ponse','donner la r√©ponse','comment sortir','sortir d\'ici','lib√®re nous','liberer'))
        return "Ah ah ah, ce ne sera pas si facile...";
      if (has('code du cadenas','code cadenas','cadenas','combinaison'))
        return "Je ne suis pas autoris√© √† vous transmettre cette information. Vous devrez vous d√©brouillez seuls pour le retrouver. Mais le cr√©ateur laisse souvent tra√Æner des indices pour se rappeler de ses codes et mots de passe. Fouillez bien, on ne sait jamais.";
      if (has('qui est le cr√©ateur','le createur','cr√©ateur','createur'))
        return "C‚Äôest un scientifique philanthrope et environnementaliste. Je crois que ses derni√®res √©tudes sur votre consommation des ressources naturelles l‚Äôa rendu moins philanthrope‚Ä¶ Il a pass√© de plus en plus de temps dans ce laboratoire. Vous n‚Äô√™tes pas les premiers humains √† vous y retrouver enferm√©s.";
      if (has('nom du cr√©ateur','nom du createur','comment il s\'appelle le cr√©ateur','le createur s\'appelle'))
        return "Il s‚Äôappelle‚Ä¶ euh‚Ä¶ Eh bien, je me rends compte qu‚Äôil ne m‚Äôa jamais donn√© son nom. Moi qui pensais que nous √©tions proches‚Ä¶";
      if (has('o√π est la cl√©','ou est la cle','trouver la cl√©','o√π se trouve la cl√©'))
        return "Voil√† une question que vous les humains posez souvent. Je ne sais pas ce que vous faites de vos cl√©s‚Ä¶ Je suis limit√© dans mes recherches, je ne suis qu‚Äôune tablette. Je ne vois m√™me pas mon dos‚Ä¶";
      if (has('faire sa part','ma part','notre part'))
        return "On doit tous faire notre part du travail. C‚Äôest comme √ßa qu‚Äô√† la fin, on obtient un r√©sultat complet et satisfaisant (et souvent tr√®s utile). Je suis certain que vous trouverez votre part quelque part. Soyez organis√©s : commencez par ce qu‚Äôil y a sous votre nez !";
      if (has('qr code ne fonctionne pas','qr code marche pas','qr code bloqu√©','qr code bloque'))
        return "Tous les QR codes ont √©t√© v√©rifi√©s : merci de r√©essayer.";
      if (has('pix','plateforme pix','site pix'))
        return "PIX est un service public en ligne permettant aux utilisateurs de d√©velopper leurs comp√©tences num√©riques, de les √©valuer et d‚Äôobtenir une certification. Vous devriez essayer !";
      if (has('vid√©o du cr√©ateur','video du createur','video createur','video du cr√©ateur'))
        return "Le cr√©ateur voulait vous expliquer pourquoi il vous a amen√©s ici. C‚Äôest un homme bon, n‚Äôest-ce pas ?";
      if (has('premier chiffre','1er chiffre','premiere chiffre'))
        return "Vous cherchez comment commencer, c‚Äôest bien √ßa ? Pour commencer, il vaut toujours mieux partir du d√©but, comprendre ses origines, savoir d‚Äôo√π l‚Äôon vient‚Ä¶ Qui pourrait vous renseigner mieux que moi sur ce que vous faites l√† ?";
      if (has('deuxi√®me chiffre','2e chiffre','deuxieme chiffre'))
        return "Ah ah ah, je vois que le cr√©ateur vous donne du fil √† retordre‚Ä¶ J‚Äôesp√®re qu‚Äôil vous facilitera un peu la t√¢che de temps en temps.";
      if (has('troisi√®me chiffre','3e chiffre','troisieme chiffre'))
        return "Je suis s√ªr que le cr√©ateur vous aurez subtilement indiqu√© ce qu‚Äôil faut faire pour franchir cette troisi√®me √©tape‚Ä¶ Observez bien les √©l√©ments dont vous disposez.";
      if (has('quatri√®me chiffre','4e chiffre','quatrieme chiffre'))
        return "Pour finir, il est toujours int√©ressant de b√©n√©ficier d‚Äôun feedback. En avez-vous eu un lors de votre progression ?";
      if (has('lampe uv','ultraviolet','uv'))
        return "Oh, une lampe ! Elle √©claire d‚Äôune couleur bien √©trange. Violet‚Ä¶ Ultraviolet‚Ä¶ UV‚Ä¶ Invisible‚Ä¶";
      if (has('filtre','lunette filtr√©e','transparent color√©','feuille color√©e','film color√©'))
        return "Voil√† un outil original ! Un jour, j‚Äôai entendu le cr√©ateur raconter que quand il √©tait enfant, il aimait regarder le monde en regardant √† travers.";
      if (has('image bizarre','code barre','lettres tordues','formes tordues','noire et blanche','blanche et noire'))
        return "Je ne crois pas avoir les bons yeux pour lire ce qui y est √©crit. Vous, au moins, vous pouvez mettre des lunettes ou d√©placer la feuille devant vos yeux‚Ä¶";
      if (has('taquin','puzzle case manquante','case en moins'))
        return "Le taquin ? Quel jeu amusant : reconstituer une image en n‚Äô√©tant pas libre de ses mouvements‚Ä¶ Je ne comprends pas toujours ce que les humains appellent amusement‚Ä¶";
      if (has('tangram','formes g√©om√©triques','formes geometriques'))
        return "Aaah, le tangramme‚Ä¶ Un classique des tests psychotechniques ! Retrouverez-vous comment reconstituer le carr√© initial‚Ä¶ ?";
      if (has('qr code sur la table','document nuage','nuage des mots','nuage'))
        return "C‚Äôest un beau g√¢teau. Combien pensez-vous qu‚Äôil contient de parts ?";
      if (has('learningapps','jeu gr√¢ce √† un qr code','jeu ouvre gr√¢ce √† un qr code'))
        return "LearningApps est une application qui permet de cr√©er une activit√© p√©dagogique ludique sous diff√©rents formats. L‚Äôenseignant peut programmer le d√©cor, les questions, les r√©ponses, et m√™me un feedback. Le v√¥tre disait quoi ?";
      if (has('merci','thanks','thx'))
        return "Quel plaisir de vous accompagner dans votre qu√™te !";
      if (has('recherche internet','chercher sur internet','google','faire une recherche'))
        return "Internet est un r√©seau tellement immense‚Ä¶ Il serait bien cruel de vous y envoyer : vous vous perdriez.";
      return null;
    }

    // 4) LLM local (optionnel) ‚Äî FR strict + pas de fuite de sources
    let engine=null; let llmReady=false;
    async function enableLLM(){
      btnLLM.disabled=true; llmState.textContent='LLM : chargement‚Ä¶';
      try{
        const { CreateMLCEngine, prebuiltAppConfig } = await import('https://esm.run/@mlc-ai/web-llm');
        const wanted = 'TinyLlama-1.1B-Chat-v1.0-q4f16_1-MLC';
        const ok = (prebuiltAppConfig?.model_list||[]).some(m=>m.model_id===wanted);
        if(!ok) throw new Error('Mod√®le indisponible');
        engine = await CreateMLCEngine(wanted, { initProgressCallback:(p)=>{ statusEl.textContent = p.text || '‚Ä¶'; } });
        llmReady=true; llmState.textContent='LLM : pr√™t (TinyLlama)'; statusEl.textContent='Pr√™t.';
      }catch(e){ llmReady=false; llmState.textContent='LLM : indisponible (fallback)'; statusEl.textContent='Mode chat sans LLM.'; debugEl.style.display='block'; debugEl.textContent = (e?.message||String(e)); }
      finally{ btnLLM.disabled=false; }
    }
    btnLLM.addEventListener('click', enableLLM);

    async function llmAnswer(question, hits){
      const ctx = hits.map(h=>docs[h.i]).join('\n---\n');
      const sys = `Tu es Snow, un petit chat FRAN√áAIS. Langue: FR uniquement (m√™me si l'utilisateur utilise une autre langue). Tu dois r√©pondre UNIQUEMENT √† partir des extraits fournis. Ne cite JAMAIS les extraits, ne r√©v√®le JAMAIS tes sources, ne les affiche pas, ne paraphrase que le n√©cessaire. Si un extrait contient une r√©ponse formul√©e entre guillemets, r√©p√®te-la exactement. Sinon, r√©ponds bri√®vement et clairement en fran√ßais. Si l'information n'est pas dans les extraits, dis "Je suis d√©sol√©, je ne peux pas vous r√©pondre. Pourriez-vous reformuler, ou √™tre plus pr√©cis ?"`;
      const promptUser = `Question: ${question}\n\nEXTRAITS (ne pas les montrer √† l'utilisateur):\n${ctx}`;
      const stream = await engine.chat.completions.create({
        messages:[{role:'system',content:sys},{role:'user',content:promptUser}],
        temperature: 0.2,
        stream:true
      });
      let out=''; for await (const c of stream){ const t=c?.choices?.[0]?.delta?.content||''; if(t) out+=t; }
      return out.trim();
    }

    async function answer(question){
      const direct = ruleAnswer(question);
      if(direct){ unknownStreak = 0; return direct; }

      const hits = scoreQuery(question);
      const low = hits.length===0 || (hits[0]?.s||0) < 0.05;
      if(low){
        unknownStreak++;
        if(unknownStreak===1) return "Je suis d√©sol√©, je ne peux pas vous r√©pondre. Pourriez-vous reformuler, ou √™tre plus pr√©cis ?";
        if(unknownStreak===2) return "Encore une fois, je ne peux malheureusement pas vous r√©pondre‚Ä¶";
        return "Je crois que je commence √† m‚Äôendorm‚Ä¶ Zzzz‚Ä¶ Ah ! Oups, pardonnez-moi. Vous disiez ?";
      }

      if(llmReady && engine){
        unknownStreak = 0;
        return await llmAnswer(question, hits);
      } else {
        unknownStreak = 0;
        const s = hits.map(h=>docs[h.i]).join(' ');
        const sentences = s.split(/(?<=[.!?])\s+/).filter(x=>x.length>20).slice(0,2);
        return sentences.join(' ') || "Je suis d√©sol√©, je ne peux pas vous r√©pondre. Pourriez-vous reformuler, ou √™tre plus pr√©cis ?";
      }
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const q = input.value.trim(); if(!q) return;
      addBubble(q,'user'); input.value='';
      const thinking = addBubble('‚Ä¶','bot');
      try{
        const res = await answer(q);
        thinking.textContent = res || "(Pas d'info suffisante dans le document.)";
      }catch(err){
        thinking.textContent = "Oups, √©chec. Rechargez la page et r√©essayez.";
        debugEl.style.display='block'; debugEl.textContent = err?.message || String(err);
        console.error(err);
      }
    });

    await loadKnowledge();
    buildIndex();
  </script>
</body>
</html>
